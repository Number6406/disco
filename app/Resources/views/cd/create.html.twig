{% extends 'base.html.twig' %}

{% block body %}

	<fieldset>
		<legend>Création de Cd</legend>
		{% form_theme form 'bootstrap_3_layout.html.twig' %}
		{{form_start(form)}}
			<div class="row">
				{{form_errors(form)}}

				<div class="col-md-5">
					<input id="artiste_hidden" style="display:none" value=""></input>
					{{form_row(form.artiste, { 'id': 'artiste' })}}
					{{form_row(form.titre)}}
					<div class="row">
						<div class="col-xs-9" style="padding:0px">
							{{form_row(form.dsortie)}}
						</div>
						<div class="col-xs-3" style="padding:0px">
							{{form_row(form.annee)}}
						</div>
					</div>
					<input id="label_hidden" style="display:none" value=""></input>
					{{form_row(form.label, { 'id': 'label' })}}
					<input id="maison_hidden" style="display:none" value=""></input>
					{{form_row(form.maison, { 'id': 'maison' })}}
					<input id="distrib_hidden" style="display:none" value=""></input>
					{{form_row(form.distrib, { 'id': 'distrib' })}}
					{{form_row(form.refLabel)}}
				</div>
				<div class="col-md-7">
					<div class="row">
						<div class="col-md-6">	
							{{form_row(form.dvd)}}
							{{form_row(form.etiquette)}}
							{{form_row(form.paulo)}}
							{{form_row(form.langue)}}
							{{form_row(form.support)}}
							{{form_row(form.type)}}
						</div>
						<div class="col-md-6">	
							{{form_row(form.genre)}}
							{{form_row(form.styles)}}
						</div>
					</div>
				</div>
			</div>
			<div class="row">
				<div class="col-md-7">
					<div class="col-md-3">
						{{form_row(form.nbPiste, { 'id': 'nbPiste' })}}
					</div>
					<div class="col-md-3">
						{{form_row(form.various, { 'id': 'various' })}}
					</div>
					<div class="row">
						<div class="table-responsive">
							<table class="table table-striped" id="pistes">

							</table>
						</div>
					</div>
				</div>
				<div class="col-md-5">
					{{form_row(form.userProgra)}}
					{{form_row(form.rotation)}}
					{{form_row(form.comment)}}
					{{form_row(form.noteMoy)}}
				</div>
			</div>

		{{form_end(form)}}
	</fieldset>


{% endblock %}

{% block javascripts %}
<script>
  $(function() {
  	function log( input, message ) {
  		$("#"+input).text(message.libelle);
      $( "#"+input+"_hidden" ).val( message.num );
    }
 	
    $( "#artiste" ).autocomplete({
      source: "{{path('autocompleteArtiste',{'like':1})}}",
      minLength: 2,
      delay: 300,
      select: function( event, ui ) {
        log('artiste',ui.item);
      }
    });

    $( "#label" ).autocomplete({
      source: "{{path('autocompleteLabel',{'like':1})}}",
      minLength: 2,
      delay: 300,
      select: function( event, ui ) {
        log('label',ui.item);
      }
    });

    $( "#maison" ).autocomplete({
      source: "{{path('autocompleteLabel',{'like':1})}}",
      minLength: 2,
      delay: 300,
      select: function( event, ui ) {
        log('maison',ui.item);
      }
    });

    $( "#distrib" ).autocomplete({
      source: "{{path('autocompleteLabel',{'like':1})}}",
      minLength: 2,
      delay: 300,
      select: function( event, ui ) {
        log('distrib',ui.item);
      }
    });

    /**
		La fonction suivante vérifie que l'artiste existe ou non
    */
    $("#artiste").blur(function() {
    	if($("#artiste").val() != "") {
			$.ajax({
			  url: "{{path('autocompleteArtiste',{'like':0})}}",
			  type: 'GET',
			  data: 'term='+$("#artiste").val()
			}).done(function(tab_exact){
				if ( tab_exact.length == 1) { 
					$("#artiste_hidden").val(tab_exact[0].num);
				} else {
		  			if(confirm("Cet Artiste semble ne pas exister... Le créer ?")) {
		  				var route = "{{path('createArtiste',{'libelle': "value" })}}";
		  				window.open(route.replace("value", $('#artiste').val()),"Pop-up","toolbar=0,location=0,directories=0,menuBar=0,resizable=0,scrollbars=yes,width=470,height=400,left=75,top=60");
			  		} else {
			  			$("#artiste_hidden").val("");
			  		};
				};

			});
    	}
  	});

  	function labelsVerif (htmlItem,hiddenItem) {
  		if(htmlItem.val() != "") {
			$.ajax({
			  url: "{{path('autocompleteLabel',{'like':0})}}",
			  type: 'GET',
			  data: 'term='+htmlItem.val()
			}).done(function(tab_exact){
				if ( tab_exact.length == 1) { 
					hiddenItem.val(tab_exact[0].num);
				} else {
		  			if(confirm("Le Label "+ htmlItem.val() +" semble ne pas exister... Le créer ?")) {
		  				var route = "{{path('createLabel',{'libelle': "value" })}}";
		  				window.open(route.replace("value", htmlItem.val()),"Pop-up","toolbar=0,location=0,directories=0,menuBar=0,resizable=0,scrollbars=yes,width=470,height=400,left=75,top=60");
			  		} else {
			  			hiddenItem.val("");
			  		};
				};
			});
  		}
  	}

  	$("#label").blur(function() { labelsVerif($("#label"),$("#label_hidden")) });
  	$("#maison").blur(function() {labelsVerif($("#maison"),$("#maison_hidden"))});
  	$("#distrib").blur(function() {labelsVerif($("#distrib"),$("#distrib_hidden"))});

  	$("#nbPiste").change(function() {
  		var nbPiste = $("#nbPiste").val();
  		var table = $("#pistes");
  		for (var i = 1; i <= nbPiste; i++) {
  			table.insertRow([i]);
  		};
  	});

  });
  </script>
{% endblock %}